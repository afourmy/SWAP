<!DOCTYPE HTML>
<html>
  <head>
  <title>TSP 2D/3D GIS visualization</title>
  <!-- Bootstrap -->
  <link href="{{ url_for('static', filename='bootstrap/bootstrap.min.css') }}" rel="stylesheet">
  <!-- Leaflet -->
  <link href="{{ url_for('static', filename='leaflet/leaflet.css') }}" rel="stylesheet">
  <!-- CSS code specific to pyTSP -->
  <link href="{{ url_for('static', filename='swap/swap.css') }}" rel="stylesheet">
  <!-- jQuery -->
  <script src="{{ url_for('static', filename='jquery/jquery.min.js') }}"></script>
  <!-- Bootstrap -->
  <script src="{{ url_for('static', filename='bootstrap/bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
  </head>
  <body>  
    <form id="aform" method="post">
      <div class="btn-group" style="z-index:500; position: absolute; left:40vw; top:10px;">  
        <div class="btn-group">
          <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Tile layer
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li><a onclick="switch_layer('osm')"> Open Street Map </a></li>
            <li><a onclick="switch_layer('gm')"> Google Maps </a></li>
            <li><a onclick="switch_layer('nasa')"> NASA </a></li>
          </ul>
        </div> 
  
        <strong><p class="btn btn-danger score" style="min-width:100px;" id="score">Score</p></strong>
      </div>
    </form>
    <div class="panel-group" style="z-index:500; position: absolute; top: 20px; left:20px;">
      <div class="panel panel-primary panel-transparent">
        <div class="panel-heading">Construction heuristics</div>
        <div class="panel-body">
          <div class="btn-group-vertical btn-block" >
            <button type="button" class="btn btn-primary" onclick="tourConstruction('nearest_neighbor')">Nearest neighbor</button>
            <button type="button" class="btn btn-primary" onclick="tourConstruction('nearest_insertion')">Nearest insertion</button>
          </div>
        </div>
      </div>
    </div>
  
    <div class="panel-group" style="z-index:500; position: absolute; top: 20px; right:20px;">
      <form id="fileform" class="form-horizontal form-label-left" enctype="multipart/form-data" method="post" >
        <div style="padding-bottom:5px;">
          <label class="btn btn-default btn-file" style="width:100%;">Import a graph
            <input id="file" name="file" style="visibility:hidden; display:none" type="file">
          </label>
        </div>
      </form>
    </div>
    <div id="map">
    <script>
      document.getElementById("file").onchange = function() {
        $("#fileform").submit();
      };
      
      function tourConstruction(algorithm){
          clearLines();
          if (window.optimizationTimer) {
            clearTimeout(window.optimizationTimer);
            window.optimizationTimer = 0;
            }
          $.ajax({
              type: "POST",
              url: "/" + algorithm,
              dataType: "json",
              success: function(data){
                  draw(...data);
              }
          });
        }

      var layers = {
        'osm': 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
        'gm': 'http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}&s=Ga',
        'nasa': 'http://tileserver.maptiler.com/nasa/{z}/{x}/{y}.jpg'
        };

      /* The following part is made of the code that depends on the dimension
      - Initialization of the map (resp. globe) and drawing of the icons
      - Initialiation of the tile layer */
      
      // 2D code
        var map = L.map('map', { zoomControl:false }).setView([39, -98], 5);
        var osm_layer = L.tileLayer(layers['osm']);
        map.addLayer(osm_layer);
        var current_layer = osm_layer;
      
        var icon_city = L.icon({
          iconUrl: 'static/images/city.png',
          iconSize: [20, 20], // size of the icon
          iconAnchor: [9, 6], // point of the icon which will correspond to marker's location
          popupAnchor: [8, -5] // point from which the popup should open relative to the iconAnchor
          });
      
        {% for id, properties in cities.items() %}  
          var marker = L.marker([
            {{ properties['latitude'] }}, 
            {{ properties['longitude'] }}], 
            );
          
          marker.bindPopup("{% for property in properties %}\
          <b>{{ property|capitalize }}</b>: {{ properties[property] }}<br>\
          {% endfor %}<br>");
          
          marker.bindTooltip("{{ properties['name'] }}", {
            permanent: false, 
            }
          );
          marker.setIcon(icon_city), 
          marker.addTo(map);
        {% endfor %}
      
      function switch_layer(layer){
        map.removeLayer(current_layer);
        current_layer = L.tileLayer(layers[layer]);
        map.addLayer(current_layer);
        }
      
      var polylines = [];
      function clearLines(){
        for (i = 0; i < polylines.length; i++) {
          map.removeLayer(polylines[i]);
          }
        }

    </script>
  </body>
</html>
