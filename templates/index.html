<!DOCTYPE HTML>
<html>
  <head>
  <title>TSP 2D/3D GIS visualization</title>
  <!-- Bootstrap -->
  <link href="{{ url_for('static', filename='bootstrap/bootstrap.min.css') }}" rel="stylesheet">
  <!-- Leaflet -->
  <link href="{{ url_for('static', filename='leaflet/leaflet.css') }}" rel="stylesheet">
  <!-- CSS code specific to SWAP -->
  <link href="{{ url_for('static', filename='swap/swap.css') }}" rel="stylesheet">
  <!-- jQuery -->
  <script src="{{ url_for('static', filename='jquery/jquery.min.js') }}"></script>
  <!-- Bootstrap -->
  <script src="{{ url_for('static', filename='bootstrap/bootstrap.min.js') }}"></script>
  <!-- Leaflet -->
  <script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
  <!-- Leaflet Polyline -->
  <script src="{{ url_for('static', filename='leaflet-polyline/leaflet.polyline.js') }}"></script>
  <!-- Leaflet Polyline -->
  <script src="{{ url_for('static', filename='d3/d3.v3.min.js') }}"></script>
  </head>
  <body>  
    <form id="aform" method="post">
      <div class="btn-group" style="z-index:500; position: absolute; left:40vw; top:10px;">  
        <div class="btn-group">
          <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">Tile layer
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li><a onclick="switch_layer('osm')"> Open Street Map </a></li>
            <li><a onclick="switch_layer('gm')"> Google Maps </a></li>
            <li><a onclick="switch_layer('nasa')"> NASA </a></li>
          </ul>
        </div> 
  
        <strong><p class="btn btn-danger score" style="min-width:100px;" id="score">Score</p></strong>
      </div>
    </form>
    <div class="panel-group" style="z-index:500; position: absolute; top: 20px; left:20px;">
      <div class="panel panel-primary panel-transparent">
        <div class="panel-heading">RWA solver</div>
        <div class="panel-body">
          <div class="btn-group-vertical btn-block" >
            <button type="button" class="btn btn-primary" onclick="RWA('shortest_path')">Routing</button>
            <button type="button" class="btn btn-primary" onclick="RWA('graph_transformation')">Graph transformation</button>
            <button type="button" class="btn btn-primary" onclick="RWA('wavelength_assignment')">Wavelength Assignment</button>
          </div>
        </div>
      </div>
    </div>
  
    <div class="panel-group" style="z-index:500; position: absolute; top: 20px; right:20px;">
      <form id="fileform" class="form-horizontal form-label-left" enctype="multipart/form-data" method="post" >
        <div style="padding-bottom:5px;">
          <label class="btn btn-default btn-file" style="width:100%;">Import a graph
            <input id="file" name="file" style="visibility:hidden; display:none" type="file">
          </label>
        </div>
      </form>
    </div>

    <div id="map">
    
    <div id="graph-transformation" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">Ã—</span>
            </button>
            <h4 class="modal-title" id="myModalLabel">Modal title</h4>
          </div>
          <div class="modal-body">
            <div align='center' id="transformed-graph"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.getElementById("file").onchange = function() {
        $("#fileform").submit();
      };
      
      // selection function
      function selectNode(d) {
        // we stop the propagation up the DOM tree so that the 
        // unselectAll event bound to the canvas is not triggered
        d3.event.stopPropagation();
        // add both the HTML and graph elements in the selected_nodes array
        selected_nodes.push([this, d]);
        d3.select(this)
          .select('image')
          .attr("xlink:href", d.selected_img);
        sendSelection();
      };
      
      function unselectAll() {
        d3.event.preventDefault();
        for (i = 0; i < selected_nodes.length; i++) {
          d3.select(selected_nodes[i][0])
            .select('image')
            .attr("xlink:href", selected_nodes[i][1].img);
        }
        selected_nodes = [];
        sendSelection();
      };
      
      function RWA(algorithm){
        $.ajax({
          type: "POST",
          url: "/" + algorithm,
          dataType: "json",
          success: function(data){
              var graph = {  
                "nodes":[],
                "links":[]
              };

              var width = 960,
                  height = 500

              var svg = d3.select("#transformed-graph").append("svg")
                .attr("width", width)
                .attr("height", height)
                .on("contextmenu", unselectAll)
                //.call(zoom)
              
              function rect(x, y, w, h) {
                return "M"+[x,y]+" l"+[w,0]+" l"+[0,h]+" l"+[-w,0]+"z";
              }
              
              var selection = svg.append("path")
                .attr("class", "selection")
                .attr("visibility", "hidden");
              
              var startSelection = function(start) {
                selection.attr("d", rect(start[0], start[0], 0, 0))
                  .attr("visibility", "visible");
              };
              
              var moveSelection = function(start, moved) {
                selection.attr("d", rect(start[0], start[1], moved[0] - start[0], moved[1] - start[1]));
              };
              
              var endSelection = function(start, end) {
                  var min_x = Math.min(start[0], end[0]);
                      max_x = Math.max(start[0], end[0]);
                      min_y = Math.min(start[1], end[1]);
                      max_y = Math.max(start[1], end[1]);
                  console.log(start, end, min_x, max_x, min_y, max_y);
                selection.attr("visibility", "hidden");
                // select all nodes in the rectangle
                d3.selectAll('.node')  //here's how you get all the nodes
                  .each(function(d) {                    
                    if (min_x <= d.x && d.x <= max_x && min_y <= d.y && d.y <= max_y) {
                      selected_nodes.push([this, d]);
                      d3.select(this)
                        .select('image')
                        .attr("xlink:href", d.selected_img);
                    }
                  });
                sendSelection();
              };
              
              svg.on("mousedown", function() {
                // same binding as leaflet: shift + left-click button for selection
                if (!d3.event.shiftKey || ((d3.event.which !== 1) && (d3.event.button !== 1))) {
                  return false;
                }
                
                var subject = d3.select(window);
                    parent = this.parentNode;
                    start = d3.mouse(parent);
                startSelection(start);
                subject
                  .on("mousemove.selection", function() {
                    moveSelection(start, d3.mouse(parent));
                  })
                  .on("mouseup.selection", function() {
                    endSelection(start, d3.mouse(parent));
                    subject
                      .on("mousemove.selection", null)
                      .on("mouseup.selection", null);
                  });
              });
              
              svg.on("touchstart", function() {
                var subject = d3.select(this);
                    parent = this.parentNode;
                    id = d3.event.changedTouches[0].identifier;
                    start = d3.touch(parent, id)
                    pos;
                  startSelection(start);
                  subject
                    .on("touchmove."+id, function() {
                      if (pos = d3.touch(parent, id)) {
                        moveSelection(start, pos);
                      }
                    })
                    .on("touchend."+id, function() {
                      if (pos = d3.touch(parent, id)) {
                        endSelection(start, pos);
                        subject
                          .on("touchmove."+id, null)
                          .on("touchend."+id, null);
                      }
                    });
              });

              var force = d3.layout.force()
                .gravity(0.2)
                .distance(10)
                .charge(-100)
                .size([width, height]);

              force
                .nodes(graph.nodes)
                .links(graph.links)
                .start();
              
              var container = svg.append("g");
            
              var link = container.selectAll(".link")
                .data(graph.links)
                .enter().append("line")
                .attr("class", "link");
            
              var node = container.selectAll(".node")
                .data(graph.nodes)
                .enter().append("g")
                .attr("class", "node")
                .call(force.drag)
                .on("click", selectNode)

              node.append("text")
                .attr("dx", 12)
                .attr("dy", ".35em")
                .text(function(d) { return d.name });

              force.on("tick", function() {
                link
                  .attr("x1", function(d) { return d.source.x; })
                  .attr("y1", function(d) { return d.source.y; })
                  .attr("x2", function(d) { return d.target.x; })
                  .attr("y2", function(d) { return d.target.y; });
                node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

              });
            $('#graph-transformation').modal('show');
          }
        });
      }

      var layers = {
        'osm': 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
        'gm': 'http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}&s=Ga',
        'nasa': 'http://tileserver.maptiler.com/nasa/{z}/{x}/{y}.jpg'
        };

      var map = L.map('map', { zoomControl:false }).setView([48, 2], 5);
      var osm_layer = L.tileLayer(layers['osm']);
      map.addLayer(osm_layer);
      var current_layer = osm_layer;
    
      var icon_city = L.icon({
        iconUrl: 'static/images/optical_switch.gif',
        iconSize: [20, 20], // size of the icon
        iconAnchor: [9, 6], // point of the icon which will correspond to marker's location
        popupAnchor: [8, -5] // point from which the popup should open relative to the iconAnchor
        });
    
      {% for properties in objects['Node'].values() %}  
        var marker = L.marker([
          {{ properties['latitude'] }}, 
          {{ properties['longitude'] }}], 
          );
        
        marker.bindPopup("{% for property in properties %}\
        <b>{{ property|capitalize }}</b>: {{ properties[property] }}<br>\
        {% endfor %}<br>");
        
        marker.bindTooltip("{{ properties['name'] }}", {permanent: false, });
        marker.setIcon(icon_city), 
        marker.addTo(map);
      {% endfor %}
      
      function switch_layer(layer){
        map.removeLayer(current_layer);
        current_layer = L.tileLayer(layers[layer]);
        map.addLayer(current_layer);
        }

      var polylines = [];
          selectedLines = [];
          link_name_to_polyline = {};

      function clearLines(){
        for (i = 0; i < polylines.length; i++) {
          map.removeLayer(polylines[i]);
          }
        }

      function unselectLines(){
        for (i = 0; i < selectedLines.length; i++) {
          selectedLines[i].setStyle({color: '#245611'});
          }
        }

      {% for link, properties in objects['Fiber'].items() %}
        var pointA = new L.LatLng({{ link['source']['latitude'] }}, {{ link['source']['longitude'] }});
        var pointB = new L.LatLng({{ link['destination']['latitude'] }}, {{ link['destination']['longitude'] }});
        var pointList = [pointA, pointB];

        var polyline = new L.Polyline(pointList, {
          color: '#245611',
          weight: 3,
          opacity: 1,
          smoothFactor: 1
          });

        polyline.addTo(map);
        polylines.push(polyline);
        link_name_to_polyline["{{ link.name }}"] = polyline;
        
        polyline.bindPopup("{% for property in properties %}\
        <b>{{ property|capitalize }}</b>: {{ properties[property] }}<br>\
        {% endfor %}<br>");
      {% endfor %}

      {% for link, properties in objects['Traffic'].items() %}
        var pointA = new L.LatLng({{ link['source']['latitude'] }}, {{ link['source']['longitude'] }});
        var pointB = new L.LatLng({{ link['destination']['latitude'] }}, {{ link['destination']['longitude'] }});
        var pointList = [pointA, pointB];

        var polyline = new L.Polyline(pointList, {
          color: '#245611',
          weight: 3,
          opacity: 1,
          smoothFactor: 1
          });

        polyline.addTo(map);
        polylines.push(polyline);
        polyline.on('click', function() {
          $.ajax({
            type: "POST",
            url: "/path_" + "{{ link.name }}",
            dataType: "json",
            success: function(data){
              unselectLines();
              for (i = 0; i < data.length; i++) {
                polyline = link_name_to_polyline[data[i]];
                selectedLines.push(polyline);
                polyline.setStyle({color: 'red'});
              }
            }
          });
        });
        
        polyline.bindPopup("{% for property in properties %}\
        <b>{{ property|capitalize }}</b>: {{ properties[property] }}<br>\
        {% endfor %}<br>");
      {% endfor %}
      /*
      var geoJson = {
        "type": "FeatureCollection",
        "features": [
          {
            "type": "Feature",
            "properties": {
              "lines": [2, 3]
            },
            "geometry": {
              "type": "LineString",
              "coordinates": [
                {% for fiber in objects['Fiber'].keys() %}
                [
                  {{ fiber['source']['longitude'] }},
                  {{ fiber['source']['latitude'] }}
                ],
                [
                  {{ fiber['destination']['longitude'] }},
                  {{ fiber['destination']['latitude'] }}
                ],
                {% endfor %}
              ]
            }
          },
        ]
      };

      var lineWeight = 6;
      var lineColors = ['red', '#08f', '#0c0', '#f80'];

      // manage overlays in groups to ease superposition order
      var outlines = L.layerGroup();
      var lineBg = L.layerGroup();
      var busLines = L.layerGroup();
      var busStops = L.layerGroup();

      var ends = [];
      function addStop(ll) {
        for(var i=0, found=false; i<ends.length && !found; i++) {
          found = (ends[i].lat == ll.lat && ends[i].lng == ll.lng);
        }
        if(!found) {
          ends.push(ll);
        }
      }

      var lineSegment, linesOnSegment, segmentCoords, segmentWidth;
      geoJson.features.forEach(function(lineSegment) {
        segmentCoords = L.GeoJSON.coordsToLatLngs(lineSegment.geometry.coordinates, 0);

        linesOnSegment = lineSegment.properties.lines;
        segmentWidth = linesOnSegment.length * (lineWeight + 1);

        L.polyline(segmentCoords, {
          color: '#000',
          weight: segmentWidth + 5,
          opacity: 1
        }).addTo(outlines);

        L.polyline(segmentCoords, {
          color: '#fff',
          weight: segmentWidth + 3,
          opacity: 1
        }).addTo(lineBg);

        for(var j=0;j<linesOnSegment.length;j++) {
          L.polyline(segmentCoords, {
            color: lineColors[linesOnSegment[j]],
            weight: lineWeight,
            opacity: 1,
            offset: j * (lineWeight + 1) - (segmentWidth / 2) + ((lineWeight + 1) / 2)
          }).addTo(busLines);
        }

        addStop(segmentCoords[0]);
        addStop(segmentCoords[segmentCoords.length - 1]);
      });

      ends.forEach(function(endCoords) {
        L.circleMarker(endCoords, {
          color: '#000',
          fillColor: '#ccc',
          fillOpacity: 1,
          radius: 10,
          weight: 4,
          opacity: 1
        }).addTo(busStops);
      });

      outlines.addTo(map);
      lineBg.addTo(map);
      busLines.addTo(map);
      busStops.addTo(map);
      */
    </script>
  </body>
</html>
